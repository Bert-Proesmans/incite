# Incite

Server simulation infrastructure.

# Install

1. Download and install Rustup, the installation tool for the Rust programming language. See [https://www.rust-lang.org]
2. Install the **Rust Nightly** toolchain. This project uses non-stable features which can only be used when compiling with Nightly releases.
3. Download/Clone this repository. `https://github.com/Bert-Proesmans/incite.git`
4. Open a command prompt and change directory to the downloaded sources.
5. Create a new file, called `.env`, for setting required environment data, see [below](#environment-file).
6. Install Diesel CLI, `cargo install diesel_cli --no-default-features --features sqlite-bundled`, this is the default to get up and running.
7. Build the database: `diesel migration run`, this step will not be necessary in the future.
8. Run the tests to see if setup might have failed: `cargo test`.
9. Build and run the lobby server: `cargo run --release --bin lobby_server`. The code is compiled and optimized.
When compilation succeeds, the file `/src/bin/lobby_server.rs` is used as main entry point. Connect your client, you should see new console output appear.

## Environment file
The binaries read configuration from an environment file. This file is called `.env` and can be placed next to the binaries or in parent folders.
For re-use purposes and usability it's recommended to create this file at the root of your repository (inside the crate workspace).
This environment file should contain a bash-like syntax, if it can be [source'd](https://ss64.com/bash/source.html) without error you're good to go!
Useful configuration entries are listed below.

- SERVER_ADDRESS
Contains the address and port on which the configured server will bind to. Clients should create a connection with this address.  
eg `SERVER_ADDRESS="127.0.0.1:1119"`

- LOG_FILEPATH
The path to the logfile. The log will contain all messages written by the server.
This path can be absolute or relative, in the later it's relative to the 'current working directory'. When running `cargo run [..]` the CWD is equal
to the crate workspace (root of the repository).  
eg `LOG_FILEPATH="./server.log"`

- DATABASE_URL
A database connection url. You can insert an sqlite db-path, postgres- or mysql connect string. When NOT using the sqlite backend it's necessary to
enable the chosen backend as a feature on the "Diesel" dependancy.  
eg `DATABASE_URL="file:server.log"`

# Project layout

Every directory inside this repository is of importance. This structure is partly enforced by Cargo as best practise.
Keep in mind that the code of this server is actually built as a library and CAN NOT be executed. There are entry points, which compile into an
executable, defined within the folder `src/bin/`!

- examples/  
	Contains Rust files which contain an executable entry point. Examples are written as a reminder on how to approach implementing a certain task.
	Each example MUST compile and they can be executed by Cargo: eg `cargo run --example print_users`

- incite-gen/  
	Contains an entire crate dedicated to generating Rust code within it's build script.
	The unit of compilation according to the Rust compiler is a crate. By pushing the protobuffer compilation in the seperate crate, which is included
	as dependancy, the compilation time of our logic crate stays low. Incite-gen is re-exported through Incite, so all autogenerated code is accessible everywhere.

- migrations/  
	This folder contains SQL declarations which alter the layout of our database. These migrations are manually constructed and applied with the Diesel Cli. See the [Diesel - Getting started guide](http://diesel.rs/guides/getting-started/) for more information.

- proto/  
	This folder contains the communications API between the Hearthstone client and this server. These proto files are compiled into Rust code by the
	incite-gen crate.

- src/  
	Contains the code of this server.  
	`src/setup.rs` contains logic for creating a new server, `src/models.rs` contains our database mapped Rust structures, etc.

	- bin/  
		Contains Rust files which are meant to be executed. These files initialize the library and start the requested server.
		Create a new file at this location if custom setup is necessary.

	- protocol/  
		Contains logic on how to process and respond to information received from the client.

- tests/  
	Contains code to make sure the server works as expected. This folder is where integration tests should be placed.
	Each test MUST compile and can be executed by Cargo: eg `cargo test`. It's also possible to run specific tests: `cargo test connect`, this will
	run all tests which name contains the string 'connect'.

# Principles

- (Almost) all components of this system MUST work automatically. Automate all the work! This includes choosing 'sane' defaults for configurable processes.
- (Almost) all code should be written in Rust itself. This includes but isn't limited to build-scripts, setup-scripts, data-provisioning. This limits the amount of components users need to have installed.
- Follow Rust principles regarding code formatting and -structuring. Try to find a readable and understandable mix of explicit- and easy to read procedures.
- Warning are errors!
